sequenceDiagram
    participant Client
    participant ProxyServer as Proxy Server
    participant AIAgent as AI Agent (Roo)
    participant MCPServer as MCP Server

    Note over Client,AIAgent: New Task Creation

    Client->>ProxyServer: POST /roo/task (inital message)
    ProxyServer->>AIAgent: Start new task
    ProxyServer->>Client: SSE: TASK_CREATED

    loop Message Processing
        AIAgent->>ProxyServer: Generate response chunk
        ProxyServer->>Client: SSE: MESSAGE (partial)

        AIAgent->>ProxyServer: Ask follow-up question
        ProxyServer->>Client: SSE: MESSAGE (followup)
    end

    Note over Client,AIAgent: Follow-up Message
    
    AIAgent->>ProxyServer: Request tool usage
    ProxyServer->>Client: SSE: MESSAGE (tool request)
    Client->>ProxyServer: POST /roo/task/{id}/action (approve tool)
    ProxyServer->>AIAgent: Tool approved
    AIAgent->>MCPServer: Execute tool
    MCPServer->>AIAgent: Tool result

    Note over Client,MCPServer: Send Message to Existing Task
    
    Client->>ProxyServer: POST /roo/task/{id}/message
    ProxyServer->>ProxyServer: Check task in history
    ProxyServer->>AIAgent: Resume task if needed
    ProxyServer->>Client: SSE: TASK_RESUMED
    AIAgent->>ProxyServer: Process new message
    ProxyServer->>Client: SSE: MESSAGE (response)
    
    alt Tool execution successful
        AIAgent->>ProxyServer: Process tool result
        ProxyServer->>Client: SSE: MESSAGE (tool result)
    else Tool execution failed
        ProxyServer->>Client: SSE: TOOL_FAILED
    end
    
    Note over Client,AIAgent: Task Continuation/Completion
    
    loop Until task complete
        AIAgent->>ProxyServer: Continue processing
        ProxyServer->>Client: SSE: MESSAGE (progress)
        
        opt Additional tools needed
            AIAgent->>ProxyServer: Request another tool
            ProxyServer->>Client: SSE: MESSAGE (tool request)
            Client->>ProxyServer: POST /roo/task/{id}/action
            ProxyServer->>AIAgent: Tool approved
            AIAgent->>MCPServer: Execute tool
            MCPServer->>AIAgent: Tool result
        end
    end
    
    AIAgent->>ProxyServer: Task completion
    ProxyServer->>Client: SSE: TASK_COMPLETED
    ProxyServer->>Client: SSE: STREAM_CLOSED
    Note over Client: Connection closed
    
    Note over Client,AIAgent: Continues with tool approval cycle as above if needed
